textLayer = require('TextLayer')
markerModule = require('MarkerModule')
{EventEmitter} = require 'events'

exports.Radar = class Radar extends Layer
  constructor: (@mainContext, options = {}) ->
    @pageComponent =  @mainContext.pageComponent
    @ListView =  @mainContext.ListView
    @backIcon = @mainContext.backIcon

    options.width= options.width ? Screen.width
    options.height= options.height ? Screen.height - 220
    options.opacity = options.opacity ? 1
    @myBackgroundColor = options.backgroundColor ? 'transparent'

    options.backgroundColor= @myBackgroundColor
    @title = "Radar"
    @currentSelection = null
    @markers = []
    @sliderValue = 1
    @currentRemainingValue = 500


    super options

    this.initControls()
    this.bindEvents()


  initControls: () ->

    @radarLayer = new Layer
      x:25
      y:Screen.height - 1070
      height: 700
      width: 700
      superLayer : this
      image:"./images/radar.png"


    @swing = new Layer
      x:@radarLayer.width - 350
      y:0
      width:354
      height:349
      originX:0
      originY:1
      image: "./images/swing_radar.png"
      opacity:1
      superLayer:@radarLayer

    @swingAnimation = new Animation
      layer: @swing
      properties:
        rotation: -360
        originX:0
        originY:1
      time: 3.5
      curve: "linear"

    # Start animation
    @swingAnimation.start()
    # Loop animation
    @swingAnimation.on Events.AnimationEnd, =>
    # Reset rotation before looping
      @swing.rotation = 0
      @swingAnimation.start()

    @zoomOut = null
    @zoomIn = null

#    #marker
    @marker_1 = new markerModule.Marker("Uebersee-Museum", "./images/uebersee-museum.png", x:550, y:250)


    @marker_1Animation_Turn = new Animation
      layer: @marker_1
      path: Path.fromString( "M572,300.5c0,-1 0,-2 0,-3c0,-1 -0.292908,-1.292908 -1,-2c-0.707092,-0.707092 -2.173096,-1.852722 -3,-3c-1.307434,-1.813995 -0.61731,-3.076111 -1,-4c-0.541199,-1.306549 -0.770264,-2.026764 -1,-3c-0.513733,-2.176239 -0.69342,-3.458801 -2,-4c-0.923889,-0.38269 -1,-1 -1,-2c0,-1 -1,-1 -1,-2c0,-1 0.38269,-2.076111 0,-3c-0.541199,-1.306549 -1.292908,-1.292908 -2,-2c-0.707092,-0.707092 0.707092,-2.292908 0,-3c-0.707092,-0.707092 -1,-1 -1,-2c0,-1 -0.292908,-1.292908 -1,-2c-0.707092,-0.707092 -1.292908,-0.292908 -2,-1c-0.707092,-0.707092 0.707092,-2.292908 0,-3c-0.707092,-0.707092 -1.292908,-0.292908 -2,-1c-0.707092,-0.707092 -1,-2 -1,-3c0,-1 -0.292908,-1.292908 -1,-2c-0.707092,-0.707108 0,-2 0,-3c0,-1 -1,-1 -1,-2c0,-1 0.30658,-2.458801 -1,-3c-0.923889,-0.38269 -1,-1 -1,-2c0,-1 -1,-1 -1,-2c0,-1 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1,-1 -1,-2c0,-1 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1,-2 -1,-3c0,-1 -1.458801,-0.693436 -2,-2c-0.38269,-0.923874 0.707092,-2.292892 0,-3c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1,-1 -1,-2c0,-1 -1,-1 -1,-2c0,-1 0.707092,-2.292892 0,-3c-0.707092,-0.707108 -1.61731,-0.076126 -2,-1c-0.541199,-1.306564 -1.292908,-1.292892 -2,-2c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1,-1 -1,-2c0,-1 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.61731,-1.076126 -1,-2c-0.541199,-1.306564 -0.292908,-2.292892 -1,-3c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -1,-1 -1,-2c0,-1 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 0,-2 -1,-2c-1,0 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1,-1 -2,-1c-1,0 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1.458801,-0.693436 -2,-2c-0.38269,-0.923874 -0.292908,-2.292892 -1,-3c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 0,-2 -1,-2c-1,0 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -1,-1 -1,-2c0,-1 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -2,0 -2,-1c0,-1 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -2,0 -2,-1c0,-1 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -2.292908,-0.292892 -3,-1c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -0.292908,-1.292892 -1,-2c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -2.076111,-0.61731 -3,-1c-1.306549,-0.541199 -2.585785,-0.585785 -4,-2c-0.707092,-0.707108 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -1.076111,-0.61731 -2,-1c-1.306549,-0.541199 -1.292908,-1.292892 -2,-2c-0.707092,-0.707108 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -1,-1 -2,-1c-1,0 -1,-1 -2,-1c-1,0 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -1,-1 -2,-1c-1,0 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -1,-2 -2,-2c-1,0 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -1,-1 -2,-1c-1,0 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -2,-1 -3,-1c-1,0 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -1.012909,-0.839813 -2,-1c-3.121429,-0.506546 -3.693451,-1.458801 -5,-2c-0.923889,-0.38269 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -1,-1 -2,-1c-1,0 -2,0 -3,0c-1,0 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -1,-1 -2,-1c-1,0 -2,0 -3,0c-1,0 -1.292908,-0.292892 -2,-1c-0.707092,-0.707108 -2.076111,0.382683 -3,0c-1.306549,-0.541199 -2,-1 -3,-1c-1,0 -2,0 -3,0c-1,0 -1,-1 -2,-1c-1,0 -2,0 -3,0c-1,0 -0.823761,-1.486259 -3,-2c-1.946503,-0.459503 -3,0 -4,0c-1,0 -1,-1 -2,-1c-1,0 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -1,-1 -2,-1c-1,0 -2,0 -3,0c-1,0 -2,0 -3,0c-1,0 -1,-1 -2,-1c-1,0 -2.292908,0.707108 -3,0c-0.707092,-0.707108 -1,-1 -2,-1c-1,0 -2,0 -3,0l0,-1")
      curve: 'linear'
      time: 2
      pathOptions:
        autoRotate: false


    @marker_1Animation_slowWalk= new Animation
      layer: @marker_1
      path: Path.fromString( "M349,119.5c0,0 0,1 0,2c0,1 1,1 1,2c0,1 0,2 0,3c0,0 0,1 0,2c0,1 0,2 0,3c0,1 -0.707092,2.292892 0,3c0.707092,0.707108 1,1 1,2c0,1 0,2 0,3c0,1 -0.707092,2.292892 0,3c0.707092,0.707108 1,1 1,2c0,1 0,2 0,3c0,1 0.707092,2.292892 0,3c-0.707092,0.707108 -1,1 -1,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 -0.707092,2.292892 0,3c0.707092,0.707108 1,1 1,2c0,1 0,2 0,3l0,1l0,1l0,1")
      curve: 'linear'
      time: 8
      pathOptions:
        autoRotate: false

    @marker_1Animation_slowWalk.on Events.AnimationEnd, =>
      @marker_1.isMoveToMeSlow = false
      @marker_1Animation_quickWalk.start()
      @marker_1.isMoveToMeFast = true

    @marker_1Animation_quickWalk = new Animation
      layer: @marker_1
      path: Path.fromString( "M350,175.5c0,0 0.292908,0.292892 1,1c0.707092,0.707108 1,0 1,1c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0.292908,1.292892 1,2c0.707092,0.707108 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 -0.458801,1.693436 -1,3c-0.38269,0.923874 0,2 0,3c0,1 -1,1 -1,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 1,1 1,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 -0.707092,2.292908 0,3c0.707092,0.707092 1,1 1,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,4c0,1 0,2 0,3c0,1 0,2 0,3c0,1 -1,1 -1,2c0,1 0,2 0,3c0,1 0.707092,2.292908 0,3c-0.707092,0.707092 -1,1 -1,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 -0.292908,1.292908 -1,2c-0.707092,0.707092 0,2 0,3c0,1 -0.707092,2.292908 0,3c0.707092,0.707092 1,1 1,2l1,0")
      curve: 'linear'
      time: 6
      pathOptions:
        autoRotate: false


    @marker_2 = new markerModule.Marker("Roland", "./images/roland.png", x:180, y:0)

    @marker_2Animation_Turn = new Animation
      layer: @marker_2
      path: Path.fromString("M206,47.5c-1,0 -2,0 -3,0c-1,0 -2.21167,0.714119 -5,3c-2.187347,1.79319 -3.881516,4.190277 -7,6c-1.93399,1.122341 -5.186005,2.692547 -7,4c-2.29454,1.653809 -4,3 -6,4c-2,1 -3.418854,1.418861 -5,3c-1.581146,1.581139 -3.186005,2.692551 -5,4c-2.29454,1.653809 -4,4 -5,5c-1,1 -2.418854,2.418861 -4,4c-1.581146,1.581139 -1.852737,3.173096 -3,4c-1.813995,1.307449 -2.852737,3.173096 -4,4c-1.813995,1.307449 -4.076126,2.617317 -5,3c-1.306564,0.541199 -2,2 -4,3c-2,1 -2.292892,1.292892 -3,2c-1.414215,1.414215 -2.852737,1.173096 -4,2c-1.813995,1.307449 -3.186005,1.692551 -5,3c-1.147263,0.826904 -2.186005,1.692551 -4,3c-1.14727,0.826904 -2.94854,2.298698 -4,4c-1.175568,1.902115 -3,1 -4,2c-1,1 -3.149345,2.474266 -4,3c-1.902115,1.175568 -1.292892,2.292892 -2,3c-0.707108,0.707108 -2.149345,0.474266 -3,1c-1.902115,1.175568 -1.386871,3.91761 -4,5c-0.923882,0.382683 -1.292892,0.292892 -2,1c-0.707108,0.707108 -1.458801,1.693436 -2,3c-0.382683,0.923882 -1.692551,2.186005 -3,4c-0.826904,1.147263 -3.458801,2.693436 -4,4c-0.382683,0.923874 -0.292892,2.292892 -1,3c-0.707108,0.707108 -2,0 -2,1c0,1 -0.076118,1.61731 -1,2c-1.306564,0.541199 -1,2 -2,2c-1,0 -1.292892,1.292892 -2,2c-0.707108,0.707108 -2,1 -2,2c0,1 -0.292892,2.292892 -1,3c-0.707108,0.707108 -2.292892,2.292892 -3,3c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -2.458801,0.693436 -3,2c-0.382683,0.923874 -1,1 -1,2c0,1 -0.617317,1.076126 -1,2c-0.541199,1.306564 -1.292892,1.292892 -2,2c-0.707108,0.707108 -0.458801,1.693436 -1,3c-0.382683,0.923874 -1,1 -1,2c0,1 0.707108,2.292892 0,3c-0.707108,0.707108 -0.617317,2.076126 -1,3c-0.541199,1.306564 -1.91761,1.386871 -3,4c-0.765366,1.847763 -0.617317,3.076126 -1,4c-0.541199,1.306564 -1.617317,2.076126 -2,3c-0.541195,1.306564 -1.292892,2.292892 -2,3c-0.707108,0.707108 -0.458805,1.693436 -1,3c-0.382683,0.923874 -0.617317,2.076126 -1,3c-0.541195,1.306564 -1,3 -2,4c-1,1 -0.617317,2.076126 -1,3c-0.541195,1.306564 -1,2 -1,3c0,1 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1.617317,2.076126 -2,3c-0.541195,1.306564 -0.693436,2.458801 -2,3c-0.923878,0.38269 -1.292892,0.292892 -2,1c-1.414215,1.414215 -0.292892,2.292892 -1,3c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.617317,1.076126 -1,2c-0.541195,1.306564 -1.617317,2.076126 -2,3c-0.541195,1.306564 -0.692547,2.186005 -2,4c-0.826904,1.147263 -1.234634,2.152237 -2,4c-0.541195,1.306564 -0.693436,2.458801 -2,3c-0.923878,0.38269 -1,1 -1,2c0,1 0.707108,2.292892 0,3c-0.707108,0.707108 -1,1 -1,2c0,1 -1,1 -1,2c0,2 -0.917606,3.386871 -2,6c-0.765368,1.847763 -0.458803,2.693436 -1,4c-0.765368,1.847748 -0.234632,4.152252 -1,6c-0.541197,1.306549 -2,3 -2,4c0,1 0.707108,2.292908 0,3c-0.707108,0.707092 -1,1 -1,2c0,1 -0.292892,1.292908 -1,2c-0.707108,0.707092 -0.458803,1.693451 -1,3c-0.382683,0.923889 -0.486258,1.823761 -1,4c-0.229753,0.973236 -1,3 -1,4c0,1 -0.617317,2.076111 -1,3c-0.541197,1.306549 -1,3 -1,4c0,1 -1,1 -1,2c0,1 0,2 0,3c0,1 -1.458803,1.693451 -2,3c-0.382683,0.923889 0,2 0,3c0,1 -1,2 -1,3c0,1 -0.458803,2.693451 -1,4c-0.382684,0.923889 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 -0.707107,2.292908 0,3c0.707108,0.707092 1,1 1,2c0,1 0,2 0,3c0,1 0.292892,1.292908 1,2c0.707108,0.707092 -0.707108,2.292908 0,3c0.707108,0.707092 1,1 1,2l0,1")
      curve: 'linear'
      time: 2
      pathOptions:
        autoRotate: false

    @marker_2Animation_Turn_2 = new Animation
      layer: @marker_2
      path: Path.fromString("M21,337.5c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 1,1 1,2c0,1 -0.707108,2.292908 0,3c0.707108,0.707092 1,1 1,2c0,1 0.458803,1.693451 1,3c0.382683,0.923889 0.458803,1.693451 1,3c0.382683,0.923889 0.292892,1.292908 1,2c0.707108,0.707092 0,2 0,3c0,1 -0.707108,2.292908 0,3c0.707108,0.707092 1,1 1,2c0,1 0,2 0,3c0,1 0.292892,1.292908 1,2c0.707108,0.707092 -0.707108,2.292908 0,3c0.707108,0.707092 1,1 1,2c0,1 0,2 0,3c0,1 -0.707108,2.292908 0,3c0.707108,0.707092 1,1 1,2c0,1 -0.707108,2.292908 0,3c0.707108,0.707092 0.617317,1.076111 1,2c0.541197,1.306549 1,2 1,3c0,1 0,2 0,3c0,1 1,1 1,2c0,1 -0.707108,2.292908 0,3c0.707108,0.707092 1,1 1,2c0,1 -0.707108,2.292908 0,3c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1,1 1,2c0,1 1,1 1,2c0,1 1,1 1,2c0,1 1,1 1,2c0,1 1,2 1,3c0,1 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0,2 0,3c0,1 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 1,2 1,3c0,1 1.292892,0.292908 2,1c0.707108,0.707092 -0.707108,2.292908 0,3c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0.617317,1.076111 1,2c0.541195,1.306549 1.617317,2.076111 2,3c0.541195,1.306549 2,2 3,3c1,1 0.693436,2.458801 2,3c0.923878,0.38269 1.292892,0.292908 2,1c0.707108,0.707092 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.877655,1.065979 2,3c1.809723,3.118469 2.692551,4.186035 4,6c0.826904,1.147278 1.292892,2.292908 2,3c0.707108,0.707092 1.292892,1.292908 2,2c0.707108,0.707092 1,1 1,2c0,1 1,1 1,2c0,1 0,2 1,2c1,0 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.693436,1.458801 2,2c0.923882,0.38269 1.292892,0.292908 2,1c0.707108,0.707092 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1,1 1,2c0,1 1.292892,0.292908 2,1c0.707108,0.707092 0,2 0,3c0,1 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1,1 2,1l0,1l0,1l1,0")
      curve: 'linear'
      time: 14
      pathOptions:
        autoRotate: false

    @marker_3 = new markerModule.Marker("Bremer-Stadtmusikanten", "./images/stadtmusikanten.png", x:50, y:100)

    @marker_3Animation_Turn = new Animation
      layer: @marker_3
      path: Path.fromString( "M76,146.5c0,1 -1,1 -1,2c0,1 -1,1 -1,2c0,1 0.707108,2.292892 0,3c-0.707108,0.707108 -1,1 -1,2c0,1 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1.292892,0.292892 -2,1c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1.292892,0.292892 -2,1c-0.707108,0.707108 -1,1 -1,2c0,1 -1,1 -1,2c0,1 -1.292892,0.292892 -2,1c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1,1 -1,2c0,1 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1,1 -1,2c0,1 -1,1 -1,2c0,1 -1,1 -1,2c0,1 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1.292892,0.292892 -2,1c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1,1 -1,2c0,1 -0.292892,1.292892 -1,2c-0.707108,0.707108 0.707108,2.292892 0,3c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1,1 -1,2c0,1 -0.617317,1.076126 -1,2c-0.541195,1.306564 -1.458805,1.693436 -2,3c-0.382683,0.923874 -1,1 -1,2c0,1 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -1,1 -1,2c0,1 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 -0.292892,1.292892 -1,2c-0.707108,0.707108 0,2 0,3c0,1 -1,1 -1,2c0,1 -0.292892,1.292892 -1,2c-0.707108,0.707108 0,2 0,3c0,1 -1,1 -1,2c0,1 0.707108,2.292892 0,3c-0.707108,0.707108 -1,1 -1,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 -0.292892,1.292908 -1,2c-0.707108,0.707092 0,2 0,3c0,1 0,2 0,3c0,1 -0.292892,1.292908 -1,2c-0.707108,0.707092 0,2 0,3c0,1 -1,1 -1,2c0,1 -1,1 -1,2c0,1 -1,1 -1,2c0,1 -0.292892,1.292908 -1,2c-0.707108,0.707092 -0.292892,1.292908 -1,2c-0.707108,0.707092 0,2 0,3c0,1 -1,1 -1,2c0,1 -0.292892,1.292908 -1,2c-0.707107,0.707092 0,2 0,3c0,1 -0.292893,1.292908 -1,2c-0.707107,0.707092 0.707107,2.292908 0,3c-0.707107,0.707092 -1,1 -1,2c0,1 0,2 0,3c0,1 0.707107,2.292908 0,3c-0.707107,0.707092 -1,1 -1,2c0,1 -0.292893,1.292908 -1,2c-0.707107,0.707092 -0.292893,1.292908 -1,2c-0.707107,0.707092 0,2 0,3c0,1 -1,1 -1,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0.292893,1.292908 1,2c0.707107,0.707092 -0.707107,2.292908 0,3c0.707107,0.707092 1,1 1,2c0,1 -0.707107,2.292908 0,3c0.707107,0.707092 1,1 1,2c0,1 1,1 1,2c0,1 1,1 1,2c0,1 0,2 0,3c0,1 1,1 1,2c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0,2 0,3c0,1 0,2 0,3c0,2 0,3 0,4c0,1 1,2 1,3c0,1 1,1 1,2c0,1 0,2 0,3c0,1 1,2 1,3c0,1 -0.707108,2.292908 0,3c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.234632,1.152252 1,3c0.541197,1.306549 1,2 1,3c0,1 1,1 1,2c0,1 -0.414213,1.585785 1,3c0.707108,0.707092 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 -0.707108,2.292908 0,3c0.707108,0.707092 1,1 1,2c0,1 0.617317,1.076111 1,2c0.541197,1.306549 1,2 1,3c0,1 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0.458805,1.693451 1,3c0.382683,0.923889 0,2 0,3c0,1 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0,2 0,3c0,1 0,2 0,3c0,1 0.617317,1.076111 1,2c0.541195,1.306549 1,2 1,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 0.292892,1.292908 1,2c0.707108,0.707092 -0.707108,2.292908 0,3c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1,1 1,2c0,1 1,1 1,2c0,1 0,2 0,3c0,1 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 1,1 1,2l0,1")
      curve: 'linear'
      time: 2
      pathOptions:
        autoRotate: false

    @marker_3Animation_Turn_2 = new Animation
      layer: @marker_3
      path: Path.fromString("M43,488.5c0,1 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 2,0 2,1c0,1 0.617317,1.076111 1,2c0.541195,1.306549 1.292892,1.292908 2,2c0.707108,0.707092 1,1 1,2c0,1 1,1 1,2c0,1 1,1 1,2c0,1 0.617317,1.076111 1,2c0.541195,1.30658 1.292892,1.292908 2,2c0.707108,0.707092 -0.306564,2.458801 1,3c0.923882,0.38269 0.292892,1.292908 1,2c0.707108,0.707092 0.617317,1.076111 1,2c0.541199,1.30658 1.458801,1.69342 2,3c0.382683,0.923889 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 1,1 1,2c0,1 1,1 1,2c0,1 0.474266,1.149353 1,2c1.175568,1.9021 1.617317,2.076111 2,3c0.541199,1.30658 1,2 2,2c1,0 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.617317,1.076111 1,2c0.541199,1.30658 1.292892,1.292908 2,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.617317,1.076111 1,2c0.541199,1.30658 0.292892,2.292908 1,3c0.707108,0.707092 2.458801,0.69342 3,2c0.382683,0.923889 0.292892,1.292908 1,2c0.707108,0.707092 2,0 2,1c0,1 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1.458801,0.69342 2,2c0.382683,0.923889 1.458801,0.69342 2,2c0.382683,0.923889 1,1 2,2c1,1 1.292892,2.292908 2,3c0.707108,0.707092 1.292892,1.292908 2,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,2.292908 1,3c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 -0.306564,2.458801 1,3c0.923882,0.38269 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 0.693436,1.458801 2,2c0.923874,0.38269 1.292892,0.292908 2,1c0.707108,0.707092 1.076126,0.61731 2,1c1.306564,0.541199 2,2 3,3c1,1 3.076126,1.61731 4,2c1.306564,0.541199 2.186005,1.692566 4,3c1.147263,0.826904 2,2 3,2c1,0 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 2.292892,-0.707092 3,0c0.707108,0.707092 1,1 1,2c0,1 0.292892,1.292908 1,2c0.707108,0.707092 1.61731,0.076111 2,1c0.541199,1.30658 1.076126,1.61731 2,2c1.306564,0.541199 1.292892,1.292908 2,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.61731,1.076111 1,2c0.541199,1.30658 1.292892,1.292908 2,2c0.707108,0.707092 1,1 2,1c1,0 0.292892,1.292908 1,2c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 0.292892,1.292908 1,2c0.707108,0.707092 1,1 2,1c1,0 1.292892,0.292908 2,1c0.707108,0.707092 1.292892,0.292908 2,1c0.707108,0.707092 1,1 2,1l1,0l1,0")
      curve: 'linear'
      time: 14
      pathOptions:
        autoRotate: false

    @marker_1Animation_Turn.on Events.AnimationEnd, =>
      @marker_2Animation_Turn_2.start()
      @marker_3Animation_Turn_2.start()

      @marker_1Animation_slowWalk.start()
      @marker_1.isMoveToMeSlow = true

    @lastPoint = {x:0, y:0}

    @marker_1.on "change:point", =>
      newX = Utils.round(@radarLayer.midX - @marker_1.x, 0)
      newY = Utils.round(@radarLayer.midY - @marker_1.y, 0)
      if @marker_1.isMoveToMeSlow
        if newX != @lastPoint.x and newY != @lastPoint.y
          @currentRemainingValue = @currentRemainingValue - 20
          @remainingDistanceValue.text = @currentRemainingValue + " m"
          @lastPoint = {x:newX, y:newY}

      else if @marker_1.isMoveToMeFast
        if newX != @lastPoint.x and newY != @lastPoint.y
          @currentRemainingValue = @currentRemainingValue - 30
          @remainingDistanceValue.text = @currentRemainingValue + " m"
          @lastPoint = {x:newX, y:newY}

    @markers.push(@marker_1)
    @markers.push(@marker_2)
    @markers.push(@marker_3)

    @currentSelection = @markers[0]

    @radarLayer.addSubLayer(@marker_1)
    @radarLayer.addSubLayer(@marker_2)
    @radarLayer.addSubLayer(@marker_3)

    sliderLayer = new Layer
      x:0
      y:Screen.height - 355
      width: Screen.width
      height: 150
      backgroundColor: @myBackgroundColor
      superLayer : this

    @minusIcon = new Layer
      x: 50
      y: 0
      width: 75
      height: 75
      image: "./images/icons/minus.png"
    sliderLayer.addSubLayer(@minusIcon);

    @plusIcon = new Layer
      x: 615
      y: 0
      width: 75
      height: 75
      image: "./images/icons/plus.png"
    sliderLayer.addSubLayer(@plusIcon);

    kmMax = new textLayer
      x: 520
      y: 50
      width: 150
      height: 100
      text:"10km"
      color: "rgb(255,255,255)"
      textAlign: "center"
      fontSize: 30
      fontFamily: "Calibri"
    sliderLayer.addSubLayer(kmMax);

    kmMin = new textLayer
      x: 70
      y: 50
      width: 150
      height: 100
      text:"1km"
      color: "rgb(255,255,255)"
      textAlign: "center"
      fontSize: 30
      fontFamily: "Calibri"
    sliderLayer.addSubLayer(kmMin);

    # Create a new Slider
    @sliderA = new SliderComponent
      knobSize: 50
      min: 1
      max: 10
      value: 1
      height: 8
      width:453
      x:145
      y:30

    @sliderValue = 1

    sliderLayer.addSubLayer(@sliderA );

    # Customize the slider
    @sliderA.fill.backgroundColor = "white"
    @sliderA.backgroundColor = "rgba(255,255,255,0.5)"
    @sliderA.knob.style.boxShadow = "0 0 0 1px rgba(0,0,0,0.1)"

    @sliderA.knob.backgroundColor = "white"

    # We initially downscale the knob
    # This way, the knob never gets blurry
    @sliderA.knob.scale = 0.8

    # Scale to 1 on DragStart
    @sliderA.knob.on Events.DragStart, ->
      this.animate
        properties: {scale: 1}
        curve: "spring(400, 30, 0)"

    # Scale back to its original scale on DragEnd
    @sliderA.knob.on Events.DragEnd, ->
      this.animate
        properties: {scale: 0.8}
        curve: "spring(400, 30, 0)"

    sliderLayer.addSubLayer(@sliderA);

    @remainingDistanceLayer = new Layer
      x:0
      y:Screen.height - 1260
      width: Screen.width
      height: 150
      opacity:1
      backgroundColor: @myBackgroundColor
      superLayer : this

    remainingDistanceLabel = new textLayer
      x:0
      y:0
      width: Screen.width
      height:120
      backgroundColor: @myBackgroundColor
      text:"Entfernung bis zum Ziel: "
      color: "rgb(255,255,255)"
      textAlign: "center"
      fontSize: 50
      fontFamily: "Calibri"

    @remainingDistanceLayer.addSubLayer(remainingDistanceLabel)

    @remainingDistanceValue = new textLayer
      x:0
      y:60
      width: Screen.width
      height:120
      backgroundColor: @myBackgroundColor
      text:"500 m"
      opacity: 0
      color: "rgb(255,255,255)"
      textAlign: "center"
      fontSize: 50
      fontFamily: "Calibri"

    @remainingDistanceLayer.addSubLayer(@remainingDistanceValue)

    @exploredPopupLayer = new Layer
      x:1500
      y:0
      width:Screen.width
      height:260
      opacity:0
      backgroundColor: "transparent"
      superLayer: this

    @exploredPopup = new Layer
      width:393
      height:82
      image: "./images/ueberseemuseum-entdeckt-nachricht.png"
      superLayer : @exploredPopupLayer
    @exploredPopup.center()

    @exploredPopupLayer.states.add
      on: opacity: 1
      off: opacity: 0

    @exploredPopupLayer.states.animationOptions =
      curve: "ease-out"
      time: 0.3

    @marker_1Animation_quickWalk.on Events.AnimationEnd, =>
      @marker_1.isMoveToMeFast = false
      @remainingDistanceLayer.x = 1500
      @exploredPopupLayer.x = 0
      @exploredPopupLayer.states.switch("on")
      @marker_1.setExplored()
      Utils.delay 6, =>
        @exploredPopupLayer.states.switch("off")
        @remainingDistanceLayer.x = 0
        @remainingDistanceValue.opacity = 0



  getRadarLayer: () ->
    return @radarLayer

  getTitle: () ->
    return @title

  hideAllMarkers: ()->
    @marker_1.hidePopup()
    @marker_2.hidePopup()
    @marker_3.hidePopup()

  deSelectAllSelectedMarkers: (myMarker)=>
    for marker in @markers
      if myMarker != marker and !marker.isExplored()
        marker.setNormal()

  rotateToStartWalk: () =>
      @marker_1Animation_Turn.start()
      @marker_2Animation_Turn.start()
      @marker_3Animation_Turn.start()

  startAnimations: () =>
    this.rotateToStartWalk()

  bindEvents: =>
    @exploredPopup.on Events.Click , =>
      @exploredPopupLayer.x = 1500
      @pageComponent.x = 1500
      @backIcon.opacity = 1
      @listView.detailSightView1.x = 0
      @remainingDistanceValue.opacity = 0
      @remainingDistanceLayer.x = 0

    @sliderA.on "change:value", =>
      roundedValue =  Utils.round(@sliderA.value, 0)

      if roundedValue > @sliderValue and roundedValue <= 10 and roundedValue != @sliderValue
        @marker_1.x = @marker_1.x + 17.5
        @marker_1.y = @marker_1.y - 17.5

        @marker_2.x = @marker_2.x - 8.5
        @marker_2.y = @marker_2.y - 8.5

        @marker_3.x = @marker_3.x + 14
        @marker_3.y = @marker_3.y + 14

      else if roundedValue < @sliderValue and roundedValue >= 0 and roundedValue != @sliderValue
        @marker_1.x = @marker_1.x - 17.5
        @marker_1.y = @marker_1.y + 17.5

        @marker_2.x = @marker_2.x + 8.5
        @marker_2.y = @marker_2.y + 8.5

        @marker_3.x = @marker_3.x - 14
        @marker_3.y = @marker_3.y - 14

      @sliderValue = roundedValue

    @plusIcon.on Events.Click, =>
      roundedValue = Utils.round(@sliderA.value + 1, 0)
      if roundedValue < 11 and roundedValue != @sliderValue
        @sliderA.value  = roundedValue
        @sliderValue = roundedValue

    @minusIcon.on Events.Click, =>
      roundedValue = Utils.round(@sliderA.value - 1, 0)
      if roundedValue > 0 and roundedValue != @sliderValue
        @sliderA.value = roundedValue
        @sliderValue = roundedValue

    @marker_1.getEmitter().on 'selected', =>
      this.deSelectAllSelectedMarkers(@marker_1)
      if @marker_1.isNormal()
        @marker_1.setSelected()
        #Hier Wert für Entfernung bis zum Ziel ändern
        @remainingDistanceValue.opacity = 1
        @startAnimations()
      else
        if !@marker_1.isExplored() and not @marker_1.isNormal()
          @marker_1.setNormal()

    @marker_2.getEmitter().on 'selected', =>
      this.deSelectAllSelectedMarkers(@marker_2)
      if @marker_2.isNormal()
        @marker_2.setSelected()
        #Hier Wert für Entfernung bis zum Ziel ändern
      else
        if !@marker_2.isExplored() and not @marker_2.isNormal()
          @marker_2.setNormal()

    @marker_3.getEmitter().on 'selected', =>
      this.deSelectAllSelectedMarkers(@marker_3)
      if @marker_3.isNormal()
        @marker_3.setSelected()
        #Hier Wert für Entfernung bis zum Ziel ändern
      else
        if !@marker_3.isExplored() and not @marker_3.isNormal()
          @marker_3.setNormal()

    @radarLayer.on Events.Click, =>
      this.hideAllMarkers()

